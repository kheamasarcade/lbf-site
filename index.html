<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kheama's Arcade • Lurk Bait Fishing</title>
<link rel="preconnect" href="https://dl.dropboxusercontent.com">
<style>
:root{
  --bg:#0b0f17;--glow1:rgba(96,165,250,.16);--glow2:rgba(244,114,182,.16);
  --panel:#0f1629;--panel2:#0f172a;--line:#1a2340;
  --text:#e5e7eb;--muted:#9ca3af;--accent1:#f472b6;--accent2:#60a5fa;--chip:#172136
}
*{box-sizing:border-box}
body{
  margin:0;color:var(--text);
  background:radial-gradient(1200px 600px at 10% -10%,var(--glow2),transparent 60%),
             radial-gradient(900px 500px at 110% 10%,var(--glow1),transparent 60%),
             var(--bg);
  font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter
}
a{color:#9ec5ff;text-decoration:none}
.top{
  max-width:1200px;margin:18px auto 0;padding:0 16px;
  display:flex;align-items:center;justify-content:space-between
}
.brand{font-weight:900;font-size:28px;letter-spacing:.3px}
.pink{color:var(--accent1)} .blue{color:var(--accent2)}
.nav{display:flex;gap:8px}
.pill{border:1px solid var(--line);background:#0b1220;border-radius:999px;padding:6px 10px;color:#b9caea;cursor:pointer}
.pill.active{background:#0f1a2f;color:#fff}
.search{min-width:260px;background:#0b1220;border:1px solid var(--line);border-radius:999px;padding:8px 12px;color:#dbe7ff}
.wrap{max-width:1200px;margin:12px auto 24px;padding:0 16px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
.card{background:linear-gradient(180deg,rgba(15,22,41,.92),rgba(15,23,42,.92));
      border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
.h2{display:flex;align-items:baseline;gap:10px;margin:0 0 8px 0}
.kicker{color:var(--muted);font-size:12px}
.tabrow{display:flex;gap:8px;margin:8px 0 12px}
.tab{padding:6px 10px;border-radius:999px;background:#0b1220;color:#93c5fd;border:1px solid var(--line);cursor:pointer}
.tab.active{background:#0f1a2f;color:#e5e7eb;border-color:#1e2a48}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.input{background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:6px 8px;color:#dbe7ff}
.small{font-size:12px;color:#9ca3af}
.badge{display:inline-block;background:#233154;border:1px solid #2f467a;color:#cfe1ff;border-radius:999px;padding:2px 8px;font-size:12px}
.list{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.row{display:grid;grid-template-columns:44px 1fr 120px;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid #0c1224}
.row:first-child{border-top:0}
.rank{width:28px;height:28px;display:grid;place-items:center;border-radius:999px;background:#0c1426;border:1px solid var(--line);color:#bcd2ff}
.title{font-weight:600}
.sub{color:#a8b3c9;font-size:12px}
.gold{justify-self:end;font-weight:800}
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:9px 10px;border-bottom:1px solid #0e1730}
.table thead th{position:sticky;top:0;background:#0f162a;cursor:pointer}
.num{text-align:right}
.empty{padding:14px;color:#9ca3af}
.footer{max-width:1200px;margin:6px auto 24px;padding:0 16px;color:#97a3bd;font-size:12px;text-align:center}
@media (min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
  <div class="top">
    <div class="brand"><span class="pink">Kheama's</span> <span class="blue">Arcade</span> · Lurk Bait Fishing</div>
    <input id="qGlobal" class="search" placeholder="Search players or species…">
    <div class="nav">
      <button class="pill active" data-view="leaderboard">Leaderboard</button>
      <button class="pill" data-view="recent">Recent</button>
      <button class="pill" data-view="dex">Dex</button>
      <button class="pill" data-view="players">Players</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="h2"><h2 style="margin:0" id="vTitle">Leaderboard</h2><div class="kicker" id="vSub">Totals</div></div>
        <div class="tabrow">
          <div class="tab active" data-span="season">Season</div>
          <div class="tab" data-span="all">All-Time</div>
        </div>

        <div id="view-leaderboard" class="list" style="display:block"></div>
        <div id="view-recent" class="table-wrap" style="display:none">
          <table class="table">
            <thead id="theadRecent"></thead>
            <tbody id="tbodyRecent"></tbody>
          </table>
          <div id="emptyRecent" class="empty" style="display:none">No results.</div>
        </div>
        <div id="view-dex" class="table-wrap" style="display:none">
          <table class="table">
            <thead id="theadDex"></thead>
            <tbody id="tbodyDex"></tbody>
          </table>
          <div id="emptyDex" class="empty" style="display:none">No results.</div>
        </div>
        <div id="view-players" class="table-wrap" style="display:none">
          <table class="table">
            <thead id="theadPlayers"></thead>
            <tbody id="tbodyPlayers"></tbody>
          </table>
          <div id="emptyPlayers" class="empty" style="display:none">No results.</div>
        </div>

        <div class="small" style="margin-top:8px">Last Data Sync: <span id="sync">loading…</span></div>
      </div>
    </div>
  </div>

  <div class="footer">Data source: Dropbox JSON snapshots exported from Kheama’s Arcade.</div>

<script>
/* ---------------- Config: Dropbox JSON ---------------- */
var URLS = {
  dex: "https://dl.dropboxusercontent.com/scl/fi/nmqf6rewo4pweftrfrjfb/dex.json?rlkey=h9z371ywynt7sqffywvbks2zn&e=1",
  leaderboard: "https://dl.dropboxusercontent.com/scl/fi/kg5tqpy0ov9m91tow1ocx/leaderboard.json?rlkey=mt10x1671vkrpw38ma5sk34v7",
  meta: "https://dl.dropboxusercontent.com/scl/fi/9r52wq4ine1b762k65bwv/meta.json?rlkey=g8myfhiuk1k4uncwq4ijt84i4",
  players: "https://dl.dropboxusercontent.com/scl/fi/dsjdjr66cjldyxbm14146/players.json?rlkey=kkfhgf47oxr1n5sjcsvrkh7xv",
  recent: "https://dl.dropboxusercontent.com/scl/fi/xsc6dg1sqsuqt0dd60u5y/recent.json?rlkey=15jkp0g6mfjz93e25lsp929pl",
  seasonBests: "https://dl.dropboxusercontent.com/scl/fi/ozchhaapgvoobfismr8wx/season_bests.json?rlkey=5tvggcnnv13q1i46f0vhbfztl"
}

/* ---------------- Utilities ---------------- */
var CACHE={}
function $(s){return document.querySelector(s)}
function $all(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
function get(u){ if(CACHE[u]) return Promise.resolve(CACHE[u]); return fetch(u,{cache:"no-store"}).then(function(r){if(!r.ok) throw new Error(r.status); return r.json()}).then(function(j){CACHE[u]=j; return j}) }
function fmtGold(n){n = Math.round(Number(n)||0); return n.toLocaleString()+"g"}
function fmtTime(epoch){ if(!epoch) return ""; return new Date(epoch*1000).toLocaleString() }
function epochFrom(v){ if(typeof v==="number") return v; var t = v ? Date.parse(v) : NaN; return isNaN(t)?null:Math.floor(t/1000) }

/* ---------------- Normalizers (tolerant field names) ---------------- */
function normLeaderboard(arr){
  arr = Array.isArray(arr)?arr:(arr&&arr.data||arr&&arr.rows||[])
  arr = arr.map(function(o){
    return { player: o.player||o.name||o.user||"unknown",
             gold: Number(o.gold||o.total_gold||o.season_gold||0) }
  })
  arr.sort(function(a,b){return b.gold-a.gold})
  for(var i=0;i<arr.length;i++) arr[i].rank=i+1
  return arr
}
function normPlayers(arr){
  arr = Array.isArray(arr)?arr:(arr&&arr.data||[])
  return arr.map(function(o){
    return { name:o.name||o.player||"unknown",
             gold:Number(o.gold||o.season_gold||0),
             casts:Number(o.casts||o.season_casts||0),
             lifetime_casts:Number(o.lifetime_casts||o.total_casts||0) }
  })
}
function normRecent(arr){
  arr = Array.isArray(arr)?arr:(arr&&arr.data||[])
  return arr.map(function(o){
    return { player:o.player||o.name||"unknown",
             item:o.item||o.species||"",
             rarity:o.rarity||"",
             stars:Number(o.stars||o.star||0),
             gold:Number(o.gold||0),
             ts:Number(o.timestamp||o.ts||o.epoch||epochFrom(o.time)||0) }
  })
}
function normDex(arr){
  arr = Array.isArray(arr)?arr:(arr&&arr.data||arr&&arr.items||[])
  return arr.map(function(o){
    return { item:o.item||o.species||o.name||"unknown",
             rarity:o.rarity||"",
             best_gold:Number(o.best_gold||o.gold||0),
             player:o.player||o.best_player||"",
             ts:Number(o.timestamp||o.ts||o.epoch||epochFrom(o.time)||0) }
  })
}

/* ---------------- State ---------------- */
var VIEW="leaderboard", SPAN="season", SEASON_START=0
function setView(v){ VIEW=v; $all(".pill").forEach(function(p){p.classList.toggle("active", p.getAttribute("data-view")===v)}) }
function setSpan(s){ SPAN=s; $all(".tab").forEach(function(t){t.classList.toggle("active", t.getAttribute("data-span")===s)}) }
function inSpan(ts){ if(!ts) return true; if(SPAN==="all") return true; return ts>=SEASON_START }

/* ---------------- Renders ---------------- */
function renderLeaderboard(list){
  var el=$("#view-leaderboard"); el.innerHTML=""
  for(var i=0;i<list.length;i++){
    var r=list[i]
    var row=document.createElement("div"); row.className="row"
    row.innerHTML = "<div class='rank'>"+r.rank+"</div>"
                   +"<div>"
                   +"  <div class='title'>"+r.player+"</div>"
                   +"  <div class='sub'>Season gold</div>"
                   +"</div>"
                   +"<div class='gold'>"+fmtGold(r.gold)+"</div>"
    el.appendChild(row)
  }
}
function renderRecent(rows){
  var thead="<tr><th>When</th><th>Player</th><th>Catch</th><th class='num'>★</th><th class='num'>Gold</th></tr>"
  $("#theadRecent").innerHTML=thead
  if(!rows.length){ $("#emptyRecent").style.display="block"; $("#tbodyRecent").innerHTML=""; return }
  $("#emptyRecent").style.display="none"
  var tb=""
  for(var i=0;i<rows.length;i++){
    var r=rows[i]; var catchTxt=r.item+(r.rarity?(" ("+r.rarity+")"):"")
    tb += "<tr><td>"+fmtTime(r.ts)+"</td><td>"+r.player+"</td><td>"+catchTxt+"</td><td class='num'>"+(r.stars||0)+"</td><td class='num'>"+fmtGold(r.gold)+"</td></tr>"
  }
  $("#tbodyRecent").innerHTML=tb
}
function renderDex(rows){
  var thead="<tr><th>Species/Item</th><th>Rarity</th><th>Record by</th><th class='num'>Best Gold</th><th>When</th></tr>"
  $("#theadDex").innerHTML=thead
  if(!rows.length){ $("#emptyDex").style.display="block"; $("#tbodyDex").innerHTML=""; return }
  $("#emptyDex").style.display="none"
  var tb=""
  for(var i=0;i<rows.length;i++){
    var r=rows[i]
    tb += "<tr><td>"+r.item+"</td><td>"+r.rarity+"</td><td>"+(r.player||"")+"</td><td class='num'>"+fmtGold(r.best_gold)+"</td><td>"+(r.ts?fmtTime(r.ts):"")+"</td></tr>"
  }
  $("#tbodyDex").innerHTML=tb
}
function renderPlayers(rows){
  var thead="<tr><th>Player</th><th class='num'>Season Gold</th><th class='num'>Season Casts</th><th class='num'>Lifetime Casts</th></tr>"
  $("#theadPlayers").innerHTML=thead
  if(!rows.length){ $("#emptyPlayers").style.display="block"; $("#tbodyPlayers").innerHTML=""; return }
  $("#emptyPlayers").style.display="none"
  var tb=""
  for(var i=0;i<rows.length;i++){
    var r=rows[i]
    tb += "<tr><td>"+r.name+"</td><td class='num'>"+fmtGold(r.gold)+"</td><td class='num'>"+(r.casts||0)+"</td><td class='num'>"+(r.lifetime_casts||0)+"</td></tr>"
  }
  $("#tbodyPlayers").innerHTML=tb
}

/* ---------------- Load & Update ---------------- */
function applySort(rows, key, desc){
  return rows.sort(function(a,b){
    var va=a[key], vb=b[key]
    var na = typeof va==="number", nb = typeof vb==="number"
    if(na && nb) return desc? vb-va : va-vb
    return desc? String(vb).localeCompare(String(va)) : String(va).localeCompare(String(vb))
  })
}

var sortRecent={key:"ts",desc:true}, sortDex={key:"best_gold",desc:true}, sortPlayers={key:"gold",desc:true}
function wireSorting(){
  $("#theadRecent").onclick=function(e){
    if(e.target.tagName!=="TH") return
    var idx=e.target.cellIndex
    var map=["ts","player","item","stars","gold"]
    sortRecent.key=map[idx]||"ts"; sortRecent.desc=!sortRecent.desc
    update()
  }
  $("#theadDex").onclick=function(e){
    if(e.target.tagName!=="TH") return
    var idx=e.target.cellIndex
    var map=["item","rarity","player","best_gold","ts"]
    sortDex.key=map[idx]||"best_gold"; sortDex.desc=!sortDex.desc
    update()
  }
  $("#theadPlayers").onclick=function(e){
    if(e.target.tagName!=="TH") return
    var idx=e.target.cellIndex
    var map=["name","gold","casts","lifetime_casts"]
    sortPlayers.key=map[idx]||"gold"; sortPlayers.desc=!sortPlayers.desc
    update()
  }
}

var DATA={meta:{}, leaderboard:[], recent:[], dex:[], players:[]}
function filterSpan(arr, keyTs){
  if(SPAN==="all") return arr.slice()
  return arr.filter(function(x){ var t = keyTs?Number(x[keyTs]||0):0; return !t || t>=SEASON_START })
}
function update(){
  var q = ($("#qGlobal").value||"").trim().toLowerCase()

  if(VIEW==="leaderboard"){
    $("#vTitle").textContent="Leaderboard"; $("#vSub").textContent=(SPAN==="season"?"Totals since season start":"All-time totals")
    $("#view-leaderboard").style.display="block"
    $("#view-recent").style.display="none"; $("#view-dex").style.display="none"; $("#view-players").style.display="none"
    var rows = DATA.leaderboard.slice()
    if(q) rows = rows.filter(function(r){return r.player.toLowerCase().indexOf(q)>-1})
    renderLeaderboard(rows)
  }

  if(VIEW==="recent"){
    $("#vTitle").textContent="Recent Catches"; $("#vSub").textContent=(SPAN==="season"?"Live, season window":"Live, all time")
    $("#view-leaderboard").style.display="none"; $("#view-dex").style.display="none"; $("#view-players").style.display="none"; $("#view-recent").style.display="block"
    var rowsR = filterSpan(DATA.recent,"ts")
    if(q) rowsR = rowsR.filter(function(r){return r.player.toLowerCase().indexOf(q)>-1 || r.item.toLowerCase().indexOf(q)>-1})
    rowsR = applySort(rowsR, sortRecent.key, sortRecent.desc)
    renderRecent(rowsR)
  }

  if(VIEW==="dex"){
    $("#vTitle").textContent="Dex"; $("#vSub").textContent="Best gold by species"
    $("#view-leaderboard").style.display="none"; $("#view-recent").style.display="none"; $("#view-players").style.display="none"; $("#view-dex").style.display="block"
    var rowsD = filterSpan(DATA.dex,"ts")
    if(q) rowsD = rowsD.filter(function(r){return r.item.toLowerCase().indexOf(q)>-1 || (r.player||"").toLowerCase().indexOf(q)>-1})
    rowsD = applySort(rowsD, sortDex.key, sortDex.desc)
    renderDex(rowsD)
  }

  if(VIEW==="players"){
    $("#vTitle").textContent="Players"; $("#vSub").textContent="Totals and casts"
    $("#view-leaderboard").style.display="none"; $("#view-recent").style.display="none"; $("#view-dex").style.display="none"; $("#view-players").style.display="block"
    var rowsP = DATA.players.slice()
    if(q) rowsP = rowsP.filter(function(r){return r.name.toLowerCase().indexOf(q)>-1})
    rowsP = applySort(rowsP, sortPlayers.key, sortPlayers.desc)
    renderPlayers(rowsP)
  }
}

function loadAll(){
  return Promise.all([
    get(URLS.meta).then(function(m){
      DATA.meta=m||{}
      var epoch = Number(m && (m.season_start_epoch||m.season||m.start_epoch))
      if(epoch && isFinite(epoch)) SEASON_START = epoch
      else{
        // fallback: Aug 1 current year at 00:00 local
        var d=new Date(); var year=d.getFullYear(); var guess=new Date(year,7,1,0,0,0,0); SEASON_START=Math.floor(guess.getTime()/1000)
      }
      $("#sync").textContent = (m && (m.exported_at_iso||"")) || ""
    }),
    get(URLS.leaderboard).then(function(j){ DATA.leaderboard = normLeaderboard(j) }),
    get(URLS.recent).then(function(j){ DATA.recent = normRecent(j) }),
    get(URLS.dex).then(function(j){ DATA.dex = normDex(j) }),
    get(URLS.players).then(function(j){ DATA.players = normPlayers(j) })
  ])
}

/* ---------------- Wire UI ---------------- */
document.addEventListener("DOMContentLoaded", function(){
  // view pills
  $all(".pill").forEach(function(p){ p.onclick=function(){ setView(p.getAttribute("data-view")); update() } })
  // span tabs
  $all(".tab").forEach(function(t){ t.onclick=function(){ setSpan(t.getAttribute("data-span")); update() } })
  // global search
  $("#qGlobal").addEventListener("input", function(){ update() })

  wireSorting()
  loadAll().then(function(){ update() })

  // refresh data every 90s
  setInterval(function(){ CACHE={}; loadAll().then(function(){ update() }) }, 90000)
})
</script>
</body>
</html>
