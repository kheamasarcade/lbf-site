<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kheama's Arcade • Lurk Bait Fishing Stats</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800;900&family=JetBrains+Mono:wght@500;700;800;900&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://dl.dropboxusercontent.com">

<style>
:root{
  --bg:#0b0f17; --glow1:rgba(96,165,250,.18); --glow2:rgba(244,114,182,.20);
  --panel:#0f1629; --line:#1a2340; --text:#e9efff; --muted:#9fb0d2;

  --junk:#6b7280; --junk-bg:#1f2430;
  --common:#cbd5e1; --common-bg:#1b2234;
  --uncommon:#34d399; --uncommon-bg:#0f2a25;
  --rare:#60a5fa; --rare-bg:#0f243d;
  --epic:#a78bfa; --epic-bg:#1a1740;
  --legend:#facc15; --legend-bg:#2a2307;

  --pill-grad:linear-gradient(90deg,#f472b6 0%,#60a5fa 100%);
  --card-grad:linear-gradient(180deg,rgba(15,22,41,.98),rgba(11,16,26,.96));
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% -10%,var(--glow2),transparent 60%),
    radial-gradient(900px 500px at 110% 10%,var(--glow1),transparent 60%),
    var(--bg);
  font:14px/1.55 "Outfit",system-ui,-apple-system,Segoe UI,Roboto;
  letter-spacing:.2px;
}

/* header */
.header{
  max-width:1280px;margin:18px auto 0;padding:0 16px 6px;
  display:flex;align-items:center;gap:14px;justify-content:space-between
}
.brand-wrap{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 6px 18px rgba(0,0,0,.5))}
.brand-name{margin:0;font-weight:900;font-size:34px;letter-spacing:.4px}
.brand-name .pink{color:#f472b6;text-shadow:0 0 6px rgba(244,114,182,.45),0 0 18px rgba(244,114,182,.25);animation:glowPink 4s ease-in-out infinite}
.brand-name .blue{color:#60a5fa;text-shadow:0 0 6px rgba(96,165,250,.45),0 0 18px rgba(96,165,250,.25);animation:glowBlue 4s ease-in-out infinite}
.subttl{color:var(--muted);font-size:14px;margin-top:2px}
@keyframes glowPink{0%,100%{text-shadow:0 0 6px rgba(244,114,182,.35),0 0 14px rgba(244,114,182,.2)}50%{text-shadow:0 0 10px rgba(244,114,182,.55),0 0 26px rgba(244,114,182,.35)}}
@keyframes glowBlue{0%,100%{text-shadow:0 0 6px rgba(96,165,250,.35),0 0 14px rgba(96,165,250,.2)}50%{text-shadow:0 0 10px rgba(96,165,250,.55),0 0 26px rgba(96,165,250,.35)}}

.controls{display:flex;align-items:center;gap:12px}
.search{
  min-width:300px;background:#0b1220;border:1px solid var(--line);
  border-radius:999px;padding:11px 14px;color:#dbe7ff;outline:none
}
.search:focus{box-shadow:0 0 0 2px #203260,0 0 20px rgba(96,165,250,.25)}
.nav{display:flex;gap:10px}
.pill{
  border:1px solid var(--line);background:#0b1220;border-radius:999px;
  padding:9px 14px;color:#b9caea;cursor:pointer;font-weight:900;position:relative;overflow:hidden;
  transition: transform .18s ease, box-shadow .18s ease
}
.pill:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,0,0,.25)}
.pill.active{color:#0a0f16;border-color:#2a3a66;background:var(--pill-grad);
  box-shadow:0 0 12px rgba(244,114,182,.35),0 0 28px rgba(96,165,250,.30),inset 0 0 0 1px rgba(255,255,255,.05)}

/* layout */
.wrap{max-width:1280px;margin:10px auto 28px;padding:0 16px}
.card{
  background:var(--card-grad);border:1px solid var(--line);border-radius:18px;padding:18px;
  box-shadow:0 22px 48px rgba(0,0,0,.45)
}
.hrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.hleft{display:flex;align-items:baseline;gap:12px}
.h2{margin:0;font-size:24px;font-weight:900;letter-spacing:.2px}
.kicker{color:var(--muted);font-size:12px}
.tabrow{display:flex;gap:10px}
.tab{
  padding:9px 14px;border-radius:999px;background:#0b1220;color:#0a0f16;
  border:1px solid var(--line);cursor:pointer;font-weight:900;position:relative;overflow:hidden;
  transition: transform .18s ease, box-shadow .18s ease
}
.tab:hover{transform:translateY(-1px)}
.tab.active{background:var(--pill-grad);color:#0a0f16;border-color:#2a3a66;box-shadow:0 0 18px rgba(244,114,182,.28)}

/* flair list */
.list{border:1px solid var(--line);border-radius:16px;overflow:hidden}
.item{display:flex;align-items:center;gap:16px;padding:14px 16px;border-top:1px solid #0c1224;transition:transform .15s ease,box-shadow .15s ease,background .15s ease}
.item:first-child{border-top:0}
.item:hover{transform:translateY(-2px);background:rgba(255,255,255,.02);box-shadow:0 10px 22px rgba(0,0,0,.35)}
.rank{width:36px;height:36px;display:grid;place-items:center;border-radius:999px;background:#0c1426;border:1px solid var(--line);color:#bcd2ff;font-weight:900}
.main{flex:1 1 auto;min-width:0}
.title{font-weight:900;font-size:18px;letter-spacing:.2px}
.sub{color:#a8b3c9;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gold{
  margin-left:auto;font-family:"JetBrains Mono",monospace;font-weight:900;
  font-size:21px;color:#ffe08a;text-shadow:0 0 3px rgba(250,204,21,.45),0 0 14px rgba(250,204,21,.38);
  letter-spacing:.2px
}

/* table */
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:12px;border-bottom:1px solid #0e1730}
.table thead th{position:sticky;top:0;background:#0f162a;cursor:pointer;font-weight:900;letter-spacing:.2px}
.table tbody tr{transition:transform .12s ease,background .12s ease}
.table tbody tr:hover{transform:translateY(-1px);background:rgba(255,255,255,.03)}
.table tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
.table tbody tr + tr{border-top:1px solid #101a36}
.num{text-align:right;font-family:"JetBrains Mono",monospace}
.table td{font-size:14px}
.table td .chip.gold{font-weight:900}
.table td .chip.star{font-weight:800}
.table td.num{font-family:"JetBrains Mono",monospace;font-weight:800}

/* chips */
.chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-size:11px;font-weight:900;border:1px solid transparent;line-height:1.15}
.r-junk{color:var(--junk);background:var(--junk-bg);border-color:#2e3544}
.r-common{color:var(--common);background:var(--common-bg);border-color:#2b3950}
.r-uncommon{color:var(--uncommon);background:var(--uncommon-bg);border-color:#1a5b4b}
.r-rare{color:var(--rare);background:var(--rare-bg);border-color:#1e3f66}
.r-epic{color:var(--epic);background:var(--epic-bg);border-color:#2e2a63}
.r-legend{color:#ffe08a;background:var(--legend-bg);border-color:#5b470c;box-shadow:0 0 14px rgba(250,204,21,.25)}

.footer{max-width:1280px;margin:8px auto 28px;padding:0 16px;color:#97a3bd;font-size:12px;text-align:center}

/* click ripple */
.pill .rpl,.tab .rpl{position:absolute;pointer-events:none;border-radius:50%;transform:translate(-50%,-50%) scale(0);background:rgba(255,255,255,.45);animation:ripple .6s ease-out forwards;mix-blend-mode:overlay}
@keyframes ripple{to{transform:translate(-50%,-50%) scale(18);opacity:0}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="brand-wrap">
    <img class="logo" src="https://www.dropbox.com/scl/fi/dwrq039ttz1ohw4qzeivq/KA.png?dl=1" alt="Kheama's Arcade">
    <div>
      <div class="brand-name"><span class="pink">Kheama's</span> <span class="blue">Arcade</span></div>
      <div class="subttl">Lurk Bait Fishing Stats</div>
    </div>
  </div>

  <div class="controls">
    <input id="qGlobal" class="search" placeholder="Search players or species…">
    <div class="nav">
      <button class="pill active" data-view="bests">Season Bests</button>
      <button class="pill" data-view="recent">Recent</button>
      <button class="pill" data-view="lp">Leaderboard & Players</button>
    </div>
  </div>
</div>

<!-- Season Bests -->
<div class="wrap" id="view-bests" style="display:block">
  <div class="card">
    <div class="hrow">
      <div class="hleft">
        <h2 class="h2">Season Bests</h2>
        <div class="kicker">Top catches by gold</div>
      </div>
      <div class="tabrow">
        <div class="tab active" data-span="season">Season</div>
        <div class="tab" data-span="all">All-Time</div>
      </div>
    </div>
    <div id="listBests" class="list"></div>
    <div class="kicker" style="margin-top:10px">Last Data Sync: <span id="syncA">loading…</span></div>
  </div>
</div>

<!-- Recent -->
<div class="wrap" id="view-recent" style="display:none">
  <div class="card">
    <div class="hrow">
      <div class="hleft"><h2 class="h2">Recent Catches</h2><div class="kicker">Live feed</div></div>
      <div class="tabrow">
        <div class="tab active" data-span="season">Season</div>
        <div class="tab" data-span="all">All-Time</div>
      </div>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead id="thRecent"></thead>
        <tbody id="tbRecent"></tbody>
      </table>
      <div id="emptyRecent" class="kicker" style="display:none">No results</div>
    </div>
    <div class="kicker" style="margin-top:10px">Last Data Sync: <span id="syncB">loading…</span></div>
  </div>
</div>

<!-- Leaderboard + Players (merged) -->
<div class="wrap" id="view-lp" style="display:none">
  <div class="card">
    <div class="hrow">
      <div class="hleft"><h2 class="h2">Leaderboard & Players</h2><div class="kicker">Rank, Gold, Casts</div></div>
      <div class="tabrow"><div class="tab active" data-span="season">Season</div><div class="tab" data-span="all">All-Time</div></div>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead id="thMerged"></thead>
        <tbody id="tbMerged"></tbody>
      </table>
      <div id="emptyMerged" class="kicker" style="display:none">No results</div>
    </div>
    <div class="kicker" style="margin-top:10px">Last Data Sync: <span id="syncC">loading…</span></div>
  </div>
</div>

<div class="footer">Data source: Dropbox JSON snapshots exported from Kheama’s Arcade.</div>

<script>
/* -------- endpoints -------- */
const URLS={
  meta:"https://dl.dropboxusercontent.com/scl/fi/9r52wq4ine1b762k65bwv/meta.json?rlkey=g8myfhiuk1k4uncwq4ijt84i4",
  recent:"https://dl.dropboxusercontent.com/scl/fi/xsc6dg1sqsuqt0dd60u5y/recent.json?rlkey=15jkp0g6mfjz93e25lsp929pl",
  seasonBests:"https://dl.dropboxusercontent.com/scl/fi/ozchhaapgvoobfismr8wx/season_bests.json?rlkey=5tvggcnnv13q1i46f0vhbfztl",
  players:"https://dl.dropboxusercontent.com/scl/fi/dsjdjr66cjldyxbm14146/players.json?rlkey=kkfhgf47oxr1n5sjcsvrkh7xv",
  leaderboard:"https://dl.dropboxusercontent.com/scl/fi/kg5tqpy0ov9m91tow1ocx/leaderboard.json?rlkey=mt10x1671vkrpw38ma5sk34v7"
};
let VERSION = Date.now();

/* -------- utils -------- */
const $=s=>document.querySelector(s);
const $all=s=>Array.from(document.querySelectorAll(s));
async function get(u){ const url=u+(u.includes("?")?"&":"?")+"v="+VERSION; const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(u); return r.json(); }
const fmtGold=n=> (Math.round(Number(n)||0)).toLocaleString()+"g";
const rClass=r=>({legendary:"r-legend",epic:"r-epic",rare:"r-rare",uncommon:"r-uncommon",junk:"r-junk"})[(r||"").toLowerCase()]||"r-common";

/* robust date -> epoch */
function epochFrom(v){
  if (!v) return null;
  if (typeof v === "number") return Math.floor(v);
  const iso = Date.parse(v);
  if (!isNaN(iso)) return Math.floor(iso/1000);
  // MM/DD/YYYY hh:mm:ss AM/PM
  let m = /^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2}) (AM|PM)$/i.exec(v);
  if (m){
    let M=+m[1], D=+m[2], Y=+m[3], h=+m[4], mn=+m[5], s=+m[6], ap=m[7].toUpperCase();
    if (ap==="PM" && h<12) h+=12; if (ap==="AM" && h===12) h=0;
    return Math.floor(new Date(Y, M-1, D, h, mn, s).getTime()/1000);
  }
  // DD/MM/YYYY hh:mm:ss AM/PM
  m = /^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2}) (AM|PM)$/i.exec(v);
  if (m){
    let D=+m[1], M=+m[2], Y=+m[3], h=+m[4], mn=+m[5], s=+m[6], ap=m[7].toUpperCase();
    if (ap==="PM" && h<12) h+=12; if (ap==="AM" && h===12) h=0;
    return Math.floor(new Date(Y, M-1, D, h, mn, s).getTime()/1000);
  }
  return null;
}
function fmtStamp(ts){
  if (!ts) return "";
  const d=new Date(ts*1000);
  const p=n=> (n<10?"0":"")+n;
  return p(d.getHours())+":"+p(d.getMinutes())+":"+p(d.getSeconds())+" "+p(d.getDate())+"/"+p(d.getMonth()+1)+"/"+d.getFullYear();
}

/* -------- state -------- */
let VIEW="bests", SPAN="season", SEASON_START=0;
const DATA={meta:{}, bests:[], recent:[], players:[], lead:[], merged:[]};

/* -------- nav/tabs -------- */
function setView(v){
  VIEW=v;
  $("#view-bests").style.display=(v==="bests")?"block":"none";
  $("#view-recent").style.display=(v==="recent")?"block":"none";
  $("#view-lp").style.display=(v==="lp")?"block":"none";
  $all(".pill").forEach(p=>p.classList.toggle("active",p.dataset.view===v));
  update();
}
function setSpan(s){ SPAN=s; $all(".tab").forEach(t=>t.classList.toggle("active",t.dataset.span===s)); update(); }
const inSpan = ts => (SPAN==="all") || !SEASON_START || (Number(ts)||0) >= SEASON_START;

$all(".pill").forEach(p=>p.addEventListener("click",()=>setView(p.dataset.view)));
$all(".tab").forEach(t=>t.addEventListener("click",()=>setSpan(t.dataset.span)));
$("#qGlobal").addEventListener("input",()=>update());

/* -------- normalizers -------- */
function normBests(j){
  const arr = Array.isArray(j)? j : (j&&j.data)||[];
  return arr.map(o=>({
    item:o.item||o.species||o.name||"unknown",
    rarity:o.rarity||"",
    player:o.player||o.best_player||"unknown",
    best_gold:Number(o.best_gold||o.gold||0),
    ts:Number(o.timestamp||epochFrom(o.date)||0),
    date:o.date||""
  })).sort((a,b)=>b.best_gold-a.best_gold);
}
function normRecent(j){
  const arr = Array.isArray(j)? j : (j&&j.data)||[];
  const out = arr.map(o=>{
    let ts = (typeof o.timestamp === "number") ? o.timestamp : null;
    if (!ts) ts = epochFrom(o.date) || epochFrom(o.time) || epochFrom(o.ts) || epochFrom(o.epoch);
    return {
      player:o.player||o.username||o.name||"unknown",
      item:o.item||o.species||"",
      rarity:o.rarity||"",
      stars:Number(o.stars||0),
      gold:Number(o.gold||0),
      ts:ts||0
    };
  });
  out.sort((a,b)=>b.ts-a.ts);      // newest first
  return out.slice(0,50);          // newest 50
}
function normPlayers(j){
  const arr = Array.isArray(j)? j : (j&&j.data)||[];
  return arr.map(o=>({
    name:o.name||o.player||o.username||"unknown",
    gold:Number(o.gold||o.season_gold||0),
    casts:Number(o.casts||o.season_casts||0),
    lifetime_casts:Number(o.lifetime_casts||o.total_casts||0)
  }));
}
function normLeader(j){
  let arr = Array.isArray(j)? j : (j&&j.data||j&&j.rows||[]);
  arr = arr.map(o=>({player:o.player||o.name||"unknown", gold:Number(o.gold||o.total_gold||o.season_gold||0)}));
  arr.sort((a,b)=>b.gold-a.gold);
  arr.forEach((r,i)=>r.rank=i+1);
  return arr;
}
/* merge leaderboard + players by name */
function buildMerged(lead, players){
  const pmap = new Map(players.map(p=>[p.name.toLowerCase(), p]));
  return lead.map(r=>{
    const p = pmap.get(r.player.toLowerCase()) || {};
    return {
      rank: r.rank, player: r.player,
      gold: r.gold,
      casts: Number(p.casts||0),
      lifetime_casts: Number(p.lifetime_casts||0)
    };
  });
}

/* -------- renderers -------- */
function refreshSync(){
  const t=Number(DATA.meta?.exported_at_epoch||0);
  const d=t? new Date(t*1000) : null;
  const p=x=>String(x).padStart(2,"0");
  const s = d? `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())} ${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}` : "";
  $("#syncA").textContent=s; $("#syncB").textContent=s; $("#syncC").textContent=s;
}
function renderBests(){
  const q = ($("#qGlobal").value||"").toLowerCase();
  const el = $("#listBests"); el.innerHTML="";
  const rows = DATA.bests.filter(r=>inSpan(r.ts) && (!q || r.item.toLowerCase().includes(q) || r.player.toLowerCase().includes(q) || r.rarity.toLowerCase().includes(q)));
  rows.forEach((r,i)=>{
    const div=document.createElement("div"); div.className="item";
    div.innerHTML = `
      <div class="rank">${i+1}</div>
      <div class="main">
        <div class="title">${r.item} <span class="chip ${rClass(r.rarity)}">${r.rarity||""}</span></div>
        <div class="sub">${r.player} · ${r.date || fmtStamp(r.ts)}</div>
      </div>
      <div class="gold">${(Math.round(r.best_gold)||0).toLocaleString()}g</div>`;
    el.appendChild(div);
  });
  if(!rows.length){ el.innerHTML = `<div class="item"><div class="main"><div class="sub">No data</div></div></div>`; }
}
function renderRecent(){
  const q = ($("#qGlobal").value||"").toLowerCase();
  let rec = DATA.recent.filter(r=>inSpan(r.ts));
  if(q){ rec=rec.filter(r=>r.player.toLowerCase().includes(q)||r.item.toLowerCase().includes(q)); }
  rec.sort((a,b)=>b.ts-a.ts); // enforce newest-first

  const head=["When","Player","Catch","★","Gold"];
  $("#thRecent").innerHTML = `<tr>${head.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  const rows = rec.map(c=>`<tr>
    <td>${fmtStamp(c.ts)}</td>
    <td>${c.player}</td>
    <td>${c.item} <span class="chip ${rClass(c.rarity)}">${c.rarity||""}</span></td>
    <td class="num"><span class="chip star">★ ${c.stars||0}</span></td>
    <td class="num"><span class="chip gold">${fmtGold(c.gold)}</span></td>
  </tr>`);
  $("#tbRecent").innerHTML = rows.join("");
  $("#emptyRecent").style.display = rows.length? "none":"block";
}
function renderMerged(){
  const q = ($("#qGlobal").value||"").toLowerCase();
  let rows = DATA.merged.slice();
  if(q){ rows = rows.filter(r=>r.player.toLowerCase().includes(q)); }
  const head=["#","Player","Season Gold","Season Casts","Lifetime Casts"];
  $("#thMerged").innerHTML = `<tr>${head.map(h=>`<th>${h}</th>`).join("")}</tr>`;
  const html = rows.map(r=>`<tr>
    <td class="num">${r.rank}</td>
    <td>${r.player}</td>
    <td class="num">${fmtGold(r.gold)}</td>
    <td class="num">${r.casts||0}</td>
    <td class="num">${r.lifetime_casts||0}</td>
  </tr>`);
  $("#tbMerged").innerHTML = html.join("");
  $("#emptyMerged").style.display = html.length? "none":"block";
}
function update(){
  if(VIEW==="bests") renderBests();
  if(VIEW==="recent") renderRecent();
  if(VIEW==="lp") renderMerged();
}

/* click ripple */
document.addEventListener("click", e=>{
  const t=e.target.closest(".pill,.tab"); if(!t) return;
  const r=document.createElement("span"); r.className="rpl";
  const rect=t.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
  r.style.left=x+"px"; r.style.top=y+"px"; const size=Math.max(rect.width,rect.height); r.style.width=r.style.height=size+"px";
  t.appendChild(r); setTimeout(()=>r.remove(),650);
}, true);

/* -------- boot -------- */
(async function init(){
  try{
    const meta = await get(URLS.meta); DATA.meta=meta||{};
    VERSION = Number(meta?.exported_at_epoch)||VERSION;
    SEASON_START = Number(meta?.season_start_epoch||0) || Math.floor(new Date(new Date().getFullYear(),7,1)/1000);
    refreshSync();

    const [recent,bests,players,leaders] = await Promise.all([
      get(URLS.recent), get(URLS.seasonBests), get(URLS.players), get(URLS.leaderboard)
    ]);
    DATA.recent = normRecent(recent);
    DATA.bests  = normBests(bests);
    DATA.players= normPlayers(players);
    DATA.lead   = normLeader(leaders);
    DATA.merged = buildMerged(DATA.lead, DATA.players);

    update();
  }catch(e){ console.error(e) }

  setInterval(async()=>{
    try{
      const meta = await get(URLS.meta); DATA.meta=meta||{};
      if(meta?.exported_at_epoch) VERSION = Number(meta.exported_at_epoch);
      refreshSync();
      const [recent,bests,players,leaders] = await Promise.all([
        get(URLS.recent), get(URLS.seasonBests), get(URLS.players), get(URLS.leaderboard)
      ]);
      DATA.recent = normRecent(recent);
      DATA.bests  = normBests(bests);
      DATA.players= normPlayers(players);
      DATA.lead   = normLeader(leaders);
      DATA.merged = buildMerged(DATA.lead, DATA.players);
      update();
    }catch(e){ console.error(e) }
  }, 90000);
})();
</script>
</body>
</html>
